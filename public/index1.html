<!DOCTYPE html>
<html>
<head>
  <title>Download youtube Video</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script></head>
<body>
    <h3>Download youtube Video</h3>
    <label>Enter Youtube Video URL:</label>

    <input type="text" name="url" id="url" placeholder="Youtube Video URL"></input>
    <button type="submit" onclick="getinfo();">Fetch info</button>
    <div id="info_con"></div>
    <script>

        function isValidUrlRegex(url) {
            const urlPattern = /^(http|https|ftp):\/\/[^\s\/$.?#]*\.[^\s]*$/i;
            return urlPattern.test(url);
        }
        function getinfo(){
            let url = $('#url').val();
            if(url && isValidUrlRegex(url)){
                $.ajax({
                    url: '/get-video-info',
                    type: 'GET',
                    data: { url : url},
                    success: function(data)
                    {
                        if(data && data.quality.length > 0){
                            let html = `<p id="vidtitle">${data.videoDetails.title}</p>`;
                                html += `<ul>`;
                                for(const q of data.quality){
                                    html += `<li>${q.quality} ${q.ratio}`;
                                    html +=`<button onclick="vid_download('${data.videoDetails.url}','${q.itag}');">Download</button></li>`;
                                }
                                html+= `</ul>`;
                            $('#info_con').html(html);
                        }
                    }
                });
            }
            console.log(url);
        }

        function vid_download(url,itag){
            // if(url && isValidUrlRegex(url)){
            //     $.ajax({
            //         url: '/download',
            //         type: 'GET',
            //         data: { url : url, itag : itag},
            //         success: function(data)
            //         {

            //         }
            //     })
            // }
            fetch(`/download?url=${url}&itag=${itag}`)
                .then(response => response.blob())
                .then(blob => {
                let title = document.getElementById('vidtitle').textContent;
                const filename = `${title}.mp4`;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                })
                .catch(error => console.error(error));
        }

    </script>

  </body>
</html>
